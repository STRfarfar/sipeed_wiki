{"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/build_flash.html": {"title": "", "desc": [], "keywords": [], "tags": [], "body": "<h1 id=\"spi-flash\">spi-flash 启动适配</h1>\n\n<p>对于从spi-flash启动系统，需要对 uboot / dts /内核配置都有所修改，打包与烧写请参考<a href=\"./onekey.html\">一键烧录及脚本使用说明</a></p>\n\n<p>以下将以16M flash为例，介绍 spi flash 的适配过程。</p>\n\n<h2 id=\"-1\">分区规划</h2>\n\n<p>下表为分区规划表：</p>\n\n<table>\n<thead>\n<tr>\n  <th>分区序号</th>\n  <th>分区大小</th>\n  <th>分区作用</th>\n  <th>地址空间及分区名</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n  <td>mtd0</td>\n  <td>1MB (0x100000)</td>\n  <td>spl+uboot</td>\n  <td>0x0000000-0x0100000 : “uboot”</td>\n</tr>\n<tr>\n  <td>mtd1</td>\n  <td>64KB (0x10000)</td>\n  <td>dtb文件</td>\n  <td>0x0100000-0x0110000 : “dtb”</td>\n</tr>\n<tr>\n  <td>mtd2</td>\n  <td>4MB (0x400000)</td>\n  <td>linux内核</td>\n  <td>0x0110000-0x0510000 : “kernel”</td>\n</tr>\n<tr>\n  <td>mtd3</td>\n  <td>剩余 (0xAF0000)</td>\n  <td>根文件系统</td>\n  <td>0x0510000-0x1000000 : “rootfs”</td>\n</tr>\n</tbody>\n</table>\n\n<h2 id=\"uboot\">uboot 修改</h2>\n\n<p>以下是对 uboot 进行适配的流程描述；</p>\n\n<h3 id=\"bootcmd\">bootcmd修改</h3>\n\n<p>在uboot源码目录下 进入 ./include/configs/</p>\n\n<pre><code>#define CONFIG_BOOTCOMMAND   \"sf probe 0:50000000; \"                           \\    \n                            \"sf read 0x80C00000 0x100000 0x4000; \"  \\\n                            \"sf read 0x80008000 0x110000 0x400000; \" \\\n                            \"bootz 0x80008000 - 0x80C00000\"\n</code></pre>\n\n<p>按照行数解释如下：</p>\n\n<blockquote>\n  <ol>\n  <li>挂载 spi-flash</li>\n  <li>读取 spi-flash 1M（0x100000）位置 64KB(0x4000)大小的 dtb 到地址<br />\n  0x80C00000</li>\n  <li>读取 spi-flash 1M+64K（0x110000）位置 4MB(0x400000)大小的 zImage<br />\n  到地址 0x80008000</li>\n  <li>从 0x80008000 启动内核，从 0x80C00000 读取设备树配置</li>\n  </ol>\n</blockquote>\n\n<p>回到 uboot 源码一级目录，<code>make ARCH=arm menuconfig</code> 进入TUI配置；</p>\n\n<p>取消勾选 <em>[ ] Enable a default value for bootcmd</em></p>\n\n<h3 id=\"bootargs\">bootargs修改</h3>\n\n<p>勾选 <em>[*] Enable boot arguments；</em></p>\n\n<p>在下方一项中填入 bootargs 参数:</p>\n\n<pre><code>console=ttyS0,115200 panic=5 rootwait root=/dev/mtdblock3 rw rootfstype=jffs2\n</code></pre>\n\n<p>(root=/dev/mtdblock3 指的是mtd设备第三分区，分区指定在dts中声明)</p>\n\n<h3 id=\"dts\">dts 修改</h3>\n\n<p>修改内核源码目录下的 ./arch/arm/boot/dts/suniv-f1c100s-licheepi-nano.dts</p>\n\n<pre><code>&amp;spi0 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;spi0_pins_a&gt;;\n    status = \"okay\";\n    spi-max-frequency = &lt;50000000&gt;;\n    flash: w25q128@0 {\n        #address-cells = &lt;1&gt;;\n        #size-cells = &lt;1&gt;;\n        compatible = \"winbond,w25q128\", \"jedec,spi-nor\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;50000000&gt;;\n        partitions {\n            compatible = \"fixed-partitions\";\n            #address-cells = &lt;1&gt;;\n            #size-cells = &lt;1&gt;;\n\n            partition@0 {\n                label = \"u-boot\";\n                reg = &lt;0x000000 0x100000&gt;;\n                read-only;\n            };\n\n            partition@100000 {\n                label = \"dtb\";\n                reg = &lt;0x100000 0x10000&gt;;\n                read-only;\n            };\n\n            partition@110000 {\n                label = \"kernel\";\n                reg = &lt;0x110000 0x400000&gt;;\n                read-only;\n            };\n\n            partition@510000 {\n                label = \"rootfs\";\n                reg = &lt;0x510000 0xAF0000&gt;;\n            };\n        };\n    };\n};\n</code></pre>\n\n<p>此处在dts中为mtd设备预先划分好了分区内容，内核将会自动解析</p>\n\n<p>另一种通过bootargs传递给内核进行解析分区信息的方法，请参考 <a href=\"http://zero.lichee.pro/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/SPI_flash_build.html#id4\">Lichee Zerospi-flash启动</a></p>\n\n<h2 id=\"-2\">内核配置修改</h2>\n\n<p>勾选 File systems ‣ Miscellaneous filesystems ‣ Journalling Flash File<br />\nSystem v2 (JFFS2) support</p>\n\n<p><img src=\"https://box.kancloud.cn/3be64c60667c0aa3a906f095171d1fda_1396x746.png\" alt=\"jffs2\" /></p>\n\n<p>修改源码下的 ./drivers/mtd/spi-nor.c</p>\n\n<p>修改对应spi-flash；如 w25q128 :</p>\n\n<pre><code>{ \"w25q128\", INFO(0xef4018, 0, 64 * 1024, 256, SECT_4K) },\n// 修改为 （不使用sector，使用块擦除）：\n{ \"w25q128\", INFO(0xef4018, 0, 64 * 1024, 256, 0) },\n</code></pre>\n\n<h2 id=\"bin\">二进制bin 打包</h2>\n\n<p>以16M 大小flash镜像打包脚本为例：</p>\n\n<pre><code>dd if=/dev/zero of=flashimg.bin bs=1M count=16 &amp;&amp;\\\ndd if=$YOUR_UBOOT_FILE of=flashimg.bin bs=1K conv=notrunc &amp;&amp;\\\ndd if=$YOUR_DTB_FILE of=flashimg.bin bs=1K seek=1024  conv=notrunc &amp;&amp;\\\ndd if=$YOUR_KERNEL_FILE of=flashimg.bin bs=1K seek=1088  conv=notrunc &amp;&amp;\\\nmkdir rootfs\ntar -xzvf $YOUR_ROOTFS_FILE -C ./rootfs &amp;&amp;\\\ncp -r $YOUR_MOD_FILE  rootfs/lib/modules/ &amp;&amp;\\\n# 为根文件系统制作jffs2镜像包\n# --pad参数指定 jffs2大小  \n# 由此计算得到 0x1000000(16M)-0x10000(64K)-0x100000(1M)-0x400000(4M)=0xAF0000\nmkfs.jffs2 -s 0x100 -e 0x10000 --pad=0xAF0000 -d rootfs/ -o jffs2.img &amp;&amp;\\\ndd if=jffs2.img of=$YOUR_IMG_FILE  bs=1K seek=5184  conv=notrunc &amp;&amp;\\\n</code></pre>\n\n<p>以上脚本通过对一个生成的16M空bin文件填充 uboot、dtb、kernel、rootfs 生成<br />\n16M 镜像，如需修改，请注意各个文件的大小，修改成对应地址（注意对齐）。</p>\n\n<p>至此，SPI系统各部分已编译完成，通过sunxi-fel进行烧写即可；</p>\n\n<h2 id=\"bin-2\">bin 烧录</h2>\n\n<pre><code>sudo sunxi-fel -p spiflash-write $YOUR_IMG_FILE\n</code></pre>\n\n<p>或请参考镜像包中的 write_flash.sh 烧录脚本；</p>\n\n<p>启动后使用 账号：root 密码：licheepi 登录</p>\n\n<blockquote>\n  <p><strong>交流与答疑</strong><br />\n  对于本节内容，如有疑问，欢迎到 <a href=\"http://bbs.lichee.pro/d/31-spi-flash\">SPI Flash系统编译交流帖</a> 提问或分享经验。</p>\n</blockquote>\n\n<h2 id=\"1\">附录 1.启动日志</h2>\n\n<pre><code>U-Boot 2018.01-05676-g00188782ee-dirty (May 19 2018 - 10:15:50 +0800) Allwinner Technology\n\nCPU:   Allwinner F Series (SUNIV)\nModel: Lichee Pi Nano\nDRAM:  32 MiB\nUsing default environment\n\nSetting up a 480x272 lcd console (overscan 0x0)\nIn:    serial@1c25000\nOut:   serial@1c25000\nErr:   serial@1c25000\nNet:   No ethernet found.\nstarting USB...\nNo controllers found\nHit any key to stop autoboot:  0 \nSF: Detected w25q128bv with page size 256 Bytes, erase size 64 KiB, total 16 MiB\ndevice 0 offset 0x100000, size 0x4000\nSF: 16384 bytes @ 0x100000 Read: OK\ndevice 0 offset 0x110000, size 0x400000\nSF: 4194304 bytes @ 0x110000 Read: OK\n## Flattened Device Tree blob at 80c00000\nBooting using the fdt blob at 0x80c00000\nLoading Device Tree to 80e4c000, end 80e511c8 ... OK\n\nStarting kernel ...\n\n[    0.000000] Booting Linux on physical CPU 0x0\n[    0.000000] Linux version 4.15.0-next-20180202-licheepi-nano+ (biglion@biglion-MRC-WX0) (gcc version 7.2.0 (Ubuntu/Linaro 7.2.8\n[    0.000000] CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=0005317f\n[    0.000000] CPU: VIVT data cache, VIVT instruction cache\n[    0.000000] OF: fdt: Machine model: Lichee Pi Nano\n[    0.000000] Memory policy: Data cache writeback\n[    0.000000] random: fast init done\n[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 8128\n[    0.000000] Kernel command line: console=ttyS0,115200 panic=5 rootwait root=/dev/mtdblock3 rw rootfstype=jffs2\n[    0.000000] Dentry cache hash table entries: 4096 (order: 2, 16384 bytes)\n[    0.000000] Inode-cache hash table entries: 2048 (order: 1, 8192 bytes)\n[    0.000000] Memory: 23752K/32768K available (5120K kernel code, 203K rwdata, 1148K rodata, 1024K init, 227K bss, 9016K reserve)\n[    0.000000] Virtual kernel memory layout:\n[    0.000000]     vector  : 0xffff0000 - 0xffff1000   (   4 kB)\n[    0.000000]     fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)\n[    0.000000]     vmalloc : 0xc2800000 - 0xff800000   ( 976 MB)\n[    0.000000]     lowmem  : 0xc0000000 - 0xc2000000   (  32 MB)\n[    0.000000]     pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)\n[    0.000000]     modules : 0xbf000000 - 0xbfe00000   (  14 MB)\n[    0.000000]       .text : 0x(ptrval) - 0x(ptrval)   (6112 kB)\n[    0.000000]       .init : 0x(ptrval) - 0x(ptrval)   (1024 kB)\n[    0.000000]       .data : 0x(ptrval) - 0x(ptrval)   ( 204 kB)\n[    0.000000]        .bss : 0x(ptrval) - 0x(ptrval)   ( 228 kB)\n[    0.000000] SLUB: HWalign=32, Order=0-3, MinObjects=0, CPUs=1, Nodes=1\n[    0.000000] NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16\n[    0.000046] sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns\n[    0.000110] clocksource: timer: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 79635851949 ns\n[    0.000639] Console: colour dummy device 80x30\n[    0.000726] Calibrating delay loop... 239.61 BogoMIPS (lpj=1198080)\n[    0.070218] pid_max: default: 32768 minimum: 301\n[    0.070625] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)\n[    0.070670] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)\n[    0.071979] CPU: Testing write buffer coherency: ok\n[    0.073630] Setting up static identity map for 0x80100000 - 0x80100058\n[    0.075957] devtmpfs: initialized\n[    0.082006] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns\n[    0.082069] futex hash table entries: 256 (order: -1, 3072 bytes)\n[    0.082348] pinctrl core: initialized pinctrl subsystem\n[    0.084280] NET: Registered protocol family 16\n[    0.085543] DMA: preallocated 256 KiB pool for atomic coherent allocations\n[    0.087223] cpuidle: using governor menu\n[    0.105860] SCSI subsystem initialized\n[    0.106112] pps_core: LinuxPPS API ver. 1 registered\n[    0.106138] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;\n[    0.106201] PTP clock support registered\n[    0.107872] clocksource: Switched to clocksource timer\n[    0.133110] NET: Registered protocol family 2\n[    0.134463] tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes)\n[    0.134531] TCP established hash table entries: 1024 (order: 0, 4096 bytes)\n[    0.134585] TCP bind hash table entries: 1024 (order: 0, 4096 bytes)\n[    0.134629] TCP: Hash tables configured (established 1024 bind 1024)\n[    0.134920] UDP hash table entries: 256 (order: 0, 4096 bytes)\n[    0.134977] UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)\n[    0.135483] NET: Registered protocol family 1\n[    0.137139] NetWinder Floating Point Emulator V0.97 (double precision)\n[    0.139083] Initialise system trusted keyrings\n[    0.139624] workingset: timestamp_bits=30 max_order=13 bucket_order=0\n[    0.152741] jffs2: version 2.2. (NAND) �© 2001-2006 Red Hat, Inc.\n[    0.166082] Key type asymmetric registered\n[    0.166121] Asymmetric key parser 'x509' registered\n[    0.166350] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 251)\n[    0.166381] io scheduler noop registered\n[    0.166397] io scheduler deadline registered\n[    0.167159] io scheduler cfq registered (default)\n[    0.167198] io scheduler mq-deadline registered\n[    0.167216] io scheduler kyber registered\n[    0.178208] suniv-pinctrl 1c20800.pinctrl: initialized sunXi PIO driver\n[    0.337019] Serial: 8250/16550 driver, 8 ports, IRQ sharing disabled\n[    0.343487] console [ttyS0] disabled\n[    0.363782] 1c25000.serial: ttyS0 at MMIO 0x1c25000 (irq = 24, base_baud = 6250000) is a 16550A\n[    0.783896] console [ttyS0] enabled\n[    0.794166] panel-simple panel: panel supply power not found, using dummy regulator\n[    0.803443] SCSI Media Changer driver v0.25 \n[    0.811012] m25p80 spi0.0: w25q128 (16384 Kbytes)\n[    0.815738] spi0.0: parsing partitions cmdlinepart\n[    0.821589] spi0.0: got parser (null)\n[    0.825276] spi0.0: parsing partitions ofpart\n[    0.829740] spi0.0: got parser ofpart\n[    0.833455] spi0.0: parser ofpart: 4\n[    0.837028] 4 ofpart partitions found on MTD device spi0.0\n[    0.842567] Creating 4 MTD partitions on \"spi0.0\":\n[    0.847372] 0x000000000000-0x000000100000 : \"u-boot\"\n[    0.854799] 0x000000100000-0x000000110000 : \"dtb\"\n[    0.861985] 0x000000110000-0x000000510000 : \"kernel\"\n[    0.869390] 0x000000510000-0x000001000000 : \"rootfs\"\n[    0.877118] i2c /dev entries driver\n[    0.909420] sunxi-mmc 1c0f000.mmc: base:0xba9bd67d irq:20\n[    0.917713] NET: Registered protocol family 17\n[    0.922406] Key type dns_resolver registered\n[    0.928846] Loading compiled-in X.509 certificates\n[    0.942725] sun4i-drm display-engine: bound 1e60000.display-backend (ops 0xc0633630)\n[    0.950770] sun4i-tcon 1c0c000.lcd-controller: Missing LVDS properties, Please upgrade your DT\n[    0.959464] sun4i-tcon 1c0c000.lcd-controller: LVDS output disabled\n[    0.966603] sun4i-drm display-engine: bound 1c0c000.lcd-controller (ops 0xc0632848)\n[    0.974412] [drm] Supports vblank timestamp caching Rev 2 (21.10.2013).\n[    0.981082] [drm] No driver support for vblank timestamp query.\n[    1.015308] mmc0: queuing unknown CIS tuple 0x01 (3 bytes)\n[    1.022825] mmc0: queuing unknown CIS tuple 0x1a (5 bytes)\n[    1.026082] mmc0: queuing unknown CIS tuple 0x1b (8 bytes)\n[    1.033931] Console: switching to colour frame buffer device 60x34\n[    1.035256] mmc0: queuing unknown CIS tuple 0x80 (1 bytes)\n[    1.035333] mmc0: queuing unknown CIS tuple 0x81 (1 bytes)\n[    1.035398] mmc0: queuing unknown CIS tuple 0x82 (1 bytes)\n[    1.035458] mmc0: new high speed SDIO card at address 0001\n[    1.095728] sun4i-drm display-engine: fb0:  frame buffer device\n[    1.102801] [drm] Initialized sun4i-drm 1.0.0 20150629 for display-engine on minor 0\n[    1.111292] cfg80211: Loading compiled-in X.509 certificates for regulatory database\n[    1.127244] cfg80211: Loaded X.509 cert 'sforshee: 00b28ddf47aef9cea7'\n[    1.135027] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2\n[    1.143760] cfg80211: failed to load regulatory.db\n[    1.220764] random: crng init done\n[    3.486017] VFS: Mounted root (jffs2 filesystem) on device 31:3.\n[    3.493872] devtmpfs: mounted\n[    3.501502] Freeing unused kernel memory: 1024K\n[   11.022364] esp8089: module is from the staging directory, the quality is unknown, you have been warned.\n[   11.039883] \n[   11.039883] ***** EAGLE DRIVER VER:bdf5087c3deb*****\n[   11.039883] \n[   11.050727] esp_sdio_dummy_probe enter\n[   11.268002] esp_sdio_init power up OK\n[   11.733562] esp_host:bdf5087c3deb\n[   11.733562] esp_target: e826c2b3c9fd 57 18202\n[   11.733562] \n[   11.743109] first normal exit\n[   11.746382] esp_sdio_remove enter\n[   11.750154] sif_disable_irq release irq failed\n[   11.868249] eagle_sdio: probe of mmc0:0001:1 failed with error -110\nifconfig: SIOCGIFFLAGS: No such device\nStarting logging: OK\nInitializing random number generator... done.\n[   12.568573] mmc0: card 0001 removed\n\nWelcome to Lichee Pi\nLichee login:\n</code></pre>\n", "toc": "", "metadata": {}, "raw": "spi-flash 启动适配\n==================\n\n对于从spi-flash启动系统，需要对 uboot / dts /内核配置都有所修改，打包与烧写请参考[一键烧录及脚本使用说明](./onekey.html)\n\n以下将以16M flash为例，介绍 spi flash 的适配过程。\n\n分区规划\n--------\n\n下表为分区规划表：\n\n|分区序号|分区大小|分区作用|地址空间及分区名\n|----|----|----|----|\n|mtd0 | 1MB (0x100000) | spl+uboot | 0x0000000-0x0100000 : “uboot”|\n|mtd1 | 64KB (0x10000) | dtb文件 | 0x0100000-0x0110000 : “dtb”|\n|mtd2 | 4MB (0x400000) | linux内核 | 0x0110000-0x0510000 : “kernel”|\n|mtd3 | 剩余 (0xAF0000) | 根文件系统 | 0x0510000-0x1000000 : “rootfs”|\n\n\nuboot 修改\n----------\n\n以下是对 uboot 进行适配的流程描述；\n\n### bootcmd修改\n\n在uboot源码目录下 进入 ./include/configs/\n\n```\n#define CONFIG_BOOTCOMMAND   \"sf probe 0:50000000; \"                           \\    \n                            \"sf read 0x80C00000 0x100000 0x4000; \"  \\\n                            \"sf read 0x80008000 0x110000 0x400000; \" \\\n                            \"bootz 0x80008000 - 0x80C00000\"\n```\n\n按照行数解释如下：\n\n> 1.  挂载 spi-flash\n> 2.  读取 spi-flash 1M（0x100000）位置 64KB(0x4000)大小的 dtb 到地址\n>     0x80C00000\n> 3.  读取 spi-flash 1M+64K（0x110000）位置 4MB(0x400000)大小的 zImage\n>     到地址 0x80008000\n> 4.  从 0x80008000 启动内核，从 0x80C00000 读取设备树配置\n\n回到 uboot 源码一级目录，`make ARCH=arm menuconfig` 进入TUI配置；\n\n取消勾选 *[ ] Enable a default value for bootcmd*\n\n### bootargs修改\n\n勾选 *[\\*] Enable boot arguments；*\n\n在下方一项中填入 bootargs 参数:\n\n    console=ttyS0,115200 panic=5 rootwait root=/dev/mtdblock3 rw rootfstype=jffs2\n\n(root=/dev/mtdblock3 指的是mtd设备第三分区，分区指定在dts中声明)\n\n### dts 修改\n\n修改内核源码目录下的 ./arch/arm/boot/dts/suniv-f1c100s-licheepi-nano.dts\n\n``` \n&spi0 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = <&spi0_pins_a>;\n    status = \"okay\";\n    spi-max-frequency = <50000000>;\n    flash: w25q128@0 {\n        #address-cells = <1>;\n        #size-cells = <1>;\n        compatible = \"winbond,w25q128\", \"jedec,spi-nor\";\n        reg = <0>;\n        spi-max-frequency = <50000000>;\n        partitions {\n            compatible = \"fixed-partitions\";\n            #address-cells = <1>;\n            #size-cells = <1>;\n\n            partition@0 {\n                label = \"u-boot\";\n                reg = <0x000000 0x100000>;\n                read-only;\n            };\n\n            partition@100000 {\n                label = \"dtb\";\n                reg = <0x100000 0x10000>;\n                read-only;\n            };\n\n            partition@110000 {\n                label = \"kernel\";\n                reg = <0x110000 0x400000>;\n                read-only;\n            };\n\n            partition@510000 {\n                label = \"rootfs\";\n                reg = <0x510000 0xAF0000>;\n            };\n        };\n    };\n};\n```\n\n此处在dts中为mtd设备预先划分好了分区内容，内核将会自动解析\n\n另一种通过bootargs传递给内核进行解析分区信息的方法，请参考 [Lichee Zerospi-flash启动](http://zero.lichee.pro/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/SPI_flash_build.html#id4)\n\n内核配置修改\n------------\n\n勾选 File systems ‣ Miscellaneous filesystems ‣ Journalling Flash File\nSystem v2 (JFFS2) support\n\n![jffs2](https://box.kancloud.cn/3be64c60667c0aa3a906f095171d1fda_1396x746.png)\n\n修改源码下的 ./drivers/mtd/spi-nor.c\n\n修改对应spi-flash；如 w25q128 :\n\n```\n{ \"w25q128\", INFO(0xef4018, 0, 64 * 1024, 256, SECT_4K) },\n// 修改为 （不使用sector，使用块擦除）：\n{ \"w25q128\", INFO(0xef4018, 0, 64 * 1024, 256, 0) },\n```\n\n二进制bin 打包\n--------------\n\n以16M 大小flash镜像打包脚本为例：\n\n```\ndd if=/dev/zero of=flashimg.bin bs=1M count=16 &&\\\ndd if=$YOUR_UBOOT_FILE of=flashimg.bin bs=1K conv=notrunc &&\\\ndd if=$YOUR_DTB_FILE of=flashimg.bin bs=1K seek=1024  conv=notrunc &&\\\ndd if=$YOUR_KERNEL_FILE of=flashimg.bin bs=1K seek=1088  conv=notrunc &&\\\nmkdir rootfs\ntar -xzvf $YOUR_ROOTFS_FILE -C ./rootfs &&\\\ncp -r $YOUR_MOD_FILE  rootfs/lib/modules/ &&\\\n# 为根文件系统制作jffs2镜像包\n# --pad参数指定 jffs2大小  \n# 由此计算得到 0x1000000(16M)-0x10000(64K)-0x100000(1M)-0x400000(4M)=0xAF0000\nmkfs.jffs2 -s 0x100 -e 0x10000 --pad=0xAF0000 -d rootfs/ -o jffs2.img &&\\\ndd if=jffs2.img of=$YOUR_IMG_FILE  bs=1K seek=5184  conv=notrunc &&\\\n```\n\n以上脚本通过对一个生成的16M空bin文件填充 uboot、dtb、kernel、rootfs 生成\n16M 镜像，如需修改，请注意各个文件的大小，修改成对应地址（注意对齐）。\n\n至此，SPI系统各部分已编译完成，通过sunxi-fel进行烧写即可；\n\nbin 烧录\n--------\n\n    sudo sunxi-fel -p spiflash-write $YOUR_IMG_FILE\n\n或请参考镜像包中的 write\\_flash.sh 烧录脚本；\n\n启动后使用 账号：root 密码：licheepi 登录\n\n> **交流与答疑**\n> 对于本节内容，如有疑问，欢迎到 [SPI Flash系统编译交流帖](http://bbs.lichee.pro/d/31-spi-flash) 提问或分享经验。\n\n附录 1.启动日志\n---------------\n\n    U-Boot 2018.01-05676-g00188782ee-dirty (May 19 2018 - 10:15:50 +0800) Allwinner Technology\n\n    CPU:   Allwinner F Series (SUNIV)\n    Model: Lichee Pi Nano\n    DRAM:  32 MiB\n    Using default environment\n\n    Setting up a 480x272 lcd console (overscan 0x0)\n    In:    serial@1c25000\n    Out:   serial@1c25000\n    Err:   serial@1c25000\n    Net:   No ethernet found.\n    starting USB...\n    No controllers found\n    Hit any key to stop autoboot:  0 \n    SF: Detected w25q128bv with page size 256 Bytes, erase size 64 KiB, total 16 MiB\n    device 0 offset 0x100000, size 0x4000\n    SF: 16384 bytes @ 0x100000 Read: OK\n    device 0 offset 0x110000, size 0x400000\n    SF: 4194304 bytes @ 0x110000 Read: OK\n    ## Flattened Device Tree blob at 80c00000\n    Booting using the fdt blob at 0x80c00000\n    Loading Device Tree to 80e4c000, end 80e511c8 ... OK\n\n    Starting kernel ...\n\n    [    0.000000] Booting Linux on physical CPU 0x0\n    [    0.000000] Linux version 4.15.0-next-20180202-licheepi-nano+ (biglion@biglion-MRC-WX0) (gcc version 7.2.0 (Ubuntu/Linaro 7.2.8\n    [    0.000000] CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=0005317f\n    [    0.000000] CPU: VIVT data cache, VIVT instruction cache\n    [    0.000000] OF: fdt: Machine model: Lichee Pi Nano\n    [    0.000000] Memory policy: Data cache writeback\n    [    0.000000] random: fast init done\n    [    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 8128\n    [    0.000000] Kernel command line: console=ttyS0,115200 panic=5 rootwait root=/dev/mtdblock3 rw rootfstype=jffs2\n    [    0.000000] Dentry cache hash table entries: 4096 (order: 2, 16384 bytes)\n    [    0.000000] Inode-cache hash table entries: 2048 (order: 1, 8192 bytes)\n    [    0.000000] Memory: 23752K/32768K available (5120K kernel code, 203K rwdata, 1148K rodata, 1024K init, 227K bss, 9016K reserve)\n    [    0.000000] Virtual kernel memory layout:\n    [    0.000000]     vector  : 0xffff0000 - 0xffff1000   (   4 kB)\n    [    0.000000]     fixmap  : 0xffc00000 - 0xfff00000   (3072 kB)\n    [    0.000000]     vmalloc : 0xc2800000 - 0xff800000   ( 976 MB)\n    [    0.000000]     lowmem  : 0xc0000000 - 0xc2000000   (  32 MB)\n    [    0.000000]     pkmap   : 0xbfe00000 - 0xc0000000   (   2 MB)\n    [    0.000000]     modules : 0xbf000000 - 0xbfe00000   (  14 MB)\n    [    0.000000]       .text : 0x(ptrval) - 0x(ptrval)   (6112 kB)\n    [    0.000000]       .init : 0x(ptrval) - 0x(ptrval)   (1024 kB)\n    [    0.000000]       .data : 0x(ptrval) - 0x(ptrval)   ( 204 kB)\n    [    0.000000]        .bss : 0x(ptrval) - 0x(ptrval)   ( 228 kB)\n    [    0.000000] SLUB: HWalign=32, Order=0-3, MinObjects=0, CPUs=1, Nodes=1\n    [    0.000000] NR_IRQS: 16, nr_irqs: 16, preallocated irqs: 16\n    [    0.000046] sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 89478484971ns\n    [    0.000110] clocksource: timer: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 79635851949 ns\n    [    0.000639] Console: colour dummy device 80x30\n    [    0.000726] Calibrating delay loop... 239.61 BogoMIPS (lpj=1198080)\n    [    0.070218] pid_max: default: 32768 minimum: 301\n    [    0.070625] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes)\n    [    0.070670] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes)\n    [    0.071979] CPU: Testing write buffer coherency: ok\n    [    0.073630] Setting up static identity map for 0x80100000 - 0x80100058\n    [    0.075957] devtmpfs: initialized\n    [    0.082006] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns\n    [    0.082069] futex hash table entries: 256 (order: -1, 3072 bytes)\n    [    0.082348] pinctrl core: initialized pinctrl subsystem\n    [    0.084280] NET: Registered protocol family 16\n    [    0.085543] DMA: preallocated 256 KiB pool for atomic coherent allocations\n    [    0.087223] cpuidle: using governor menu\n    [    0.105860] SCSI subsystem initialized\n    [    0.106112] pps_core: LinuxPPS API ver. 1 registered\n    [    0.106138] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti <giometti@linux.it>\n    [    0.106201] PTP clock support registered\n    [    0.107872] clocksource: Switched to clocksource timer\n    [    0.133110] NET: Registered protocol family 2\n    [    0.134463] tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes)\n    [    0.134531] TCP established hash table entries: 1024 (order: 0, 4096 bytes)\n    [    0.134585] TCP bind hash table entries: 1024 (order: 0, 4096 bytes)\n    [    0.134629] TCP: Hash tables configured (established 1024 bind 1024)\n    [    0.134920] UDP hash table entries: 256 (order: 0, 4096 bytes)\n    [    0.134977] UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)\n    [    0.135483] NET: Registered protocol family 1\n    [    0.137139] NetWinder Floating Point Emulator V0.97 (double precision)\n    [    0.139083] Initialise system trusted keyrings\n    [    0.139624] workingset: timestamp_bits=30 max_order=13 bucket_order=0\n    [    0.152741] jffs2: version 2.2. (NAND) �© 2001-2006 Red Hat, Inc.\n    [    0.166082] Key type asymmetric registered\n    [    0.166121] Asymmetric key parser 'x509' registered\n    [    0.166350] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 251)\n    [    0.166381] io scheduler noop registered\n    [    0.166397] io scheduler deadline registered\n    [    0.167159] io scheduler cfq registered (default)\n    [    0.167198] io scheduler mq-deadline registered\n    [    0.167216] io scheduler kyber registered\n    [    0.178208] suniv-pinctrl 1c20800.pinctrl: initialized sunXi PIO driver\n    [    0.337019] Serial: 8250/16550 driver, 8 ports, IRQ sharing disabled\n    [    0.343487] console [ttyS0] disabled\n    [    0.363782] 1c25000.serial: ttyS0 at MMIO 0x1c25000 (irq = 24, base_baud = 6250000) is a 16550A\n    [    0.783896] console [ttyS0] enabled\n    [    0.794166] panel-simple panel: panel supply power not found, using dummy regulator\n    [    0.803443] SCSI Media Changer driver v0.25 \n    [    0.811012] m25p80 spi0.0: w25q128 (16384 Kbytes)\n    [    0.815738] spi0.0: parsing partitions cmdlinepart\n    [    0.821589] spi0.0: got parser (null)\n    [    0.825276] spi0.0: parsing partitions ofpart\n    [    0.829740] spi0.0: got parser ofpart\n    [    0.833455] spi0.0: parser ofpart: 4\n    [    0.837028] 4 ofpart partitions found on MTD device spi0.0\n    [    0.842567] Creating 4 MTD partitions on \"spi0.0\":\n    [    0.847372] 0x000000000000-0x000000100000 : \"u-boot\"\n    [    0.854799] 0x000000100000-0x000000110000 : \"dtb\"\n    [    0.861985] 0x000000110000-0x000000510000 : \"kernel\"\n    [    0.869390] 0x000000510000-0x000001000000 : \"rootfs\"\n    [    0.877118] i2c /dev entries driver\n    [    0.909420] sunxi-mmc 1c0f000.mmc: base:0xba9bd67d irq:20\n    [    0.917713] NET: Registered protocol family 17\n    [    0.922406] Key type dns_resolver registered\n    [    0.928846] Loading compiled-in X.509 certificates\n    [    0.942725] sun4i-drm display-engine: bound 1e60000.display-backend (ops 0xc0633630)\n    [    0.950770] sun4i-tcon 1c0c000.lcd-controller: Missing LVDS properties, Please upgrade your DT\n    [    0.959464] sun4i-tcon 1c0c000.lcd-controller: LVDS output disabled\n    [    0.966603] sun4i-drm display-engine: bound 1c0c000.lcd-controller (ops 0xc0632848)\n    [    0.974412] [drm] Supports vblank timestamp caching Rev 2 (21.10.2013).\n    [    0.981082] [drm] No driver support for vblank timestamp query.\n    [    1.015308] mmc0: queuing unknown CIS tuple 0x01 (3 bytes)\n    [    1.022825] mmc0: queuing unknown CIS tuple 0x1a (5 bytes)\n    [    1.026082] mmc0: queuing unknown CIS tuple 0x1b (8 bytes)\n    [    1.033931] Console: switching to colour frame buffer device 60x34\n    [    1.035256] mmc0: queuing unknown CIS tuple 0x80 (1 bytes)\n    [    1.035333] mmc0: queuing unknown CIS tuple 0x81 (1 bytes)\n    [    1.035398] mmc0: queuing unknown CIS tuple 0x82 (1 bytes)\n    [    1.035458] mmc0: new high speed SDIO card at address 0001\n    [    1.095728] sun4i-drm display-engine: fb0:  frame buffer device\n    [    1.102801] [drm] Initialized sun4i-drm 1.0.0 20150629 for display-engine on minor 0\n    [    1.111292] cfg80211: Loading compiled-in X.509 certificates for regulatory database\n    [    1.127244] cfg80211: Loaded X.509 cert 'sforshee: 00b28ddf47aef9cea7'\n    [    1.135027] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2\n    [    1.143760] cfg80211: failed to load regulatory.db\n    [    1.220764] random: crng init done\n    [    3.486017] VFS: Mounted root (jffs2 filesystem) on device 31:3.\n    [    3.493872] devtmpfs: mounted\n    [    3.501502] Freeing unused kernel memory: 1024K\n    [   11.022364] esp8089: module is from the staging directory, the quality is unknown, you have been warned.\n    [   11.039883] \n    [   11.039883] ***** EAGLE DRIVER VER:bdf5087c3deb*****\n    [   11.039883] \n    [   11.050727] esp_sdio_dummy_probe enter\n    [   11.268002] esp_sdio_init power up OK\n    [   11.733562] esp_host:bdf5087c3deb\n    [   11.733562] esp_target: e826c2b3c9fd 57 18202\n    [   11.733562] \n    [   11.743109] first normal exit\n    [   11.746382] esp_sdio_remove enter\n    [   11.750154] sif_disable_irq release irq failed\n    [   11.868249] eagle_sdio: probe of mmc0:0001:1 failed with error -110\n    ifconfig: SIOCGIFFLAGS: No such device\n    Starting logging: OK\n    Initializing random number generator... done.\n    [   12.568573] mmc0: card 0001 removed\n\n    Welcome to Lichee Pi\n    Lichee login:", "sidebar": "\n            <div id=\"sidebar_wrapper\">\n                <div id=\"sidebar\">\n                    <div id=\"sidebar_title\">\n                        \n                    </div>\n                    <ul class=\"show\">\n<li class=\"active_parent no_link\"><a><span class=\"label\">LicheePi</span><span class=\"sub_indicator\"></span></a><ul class=\"show\">\n<li class=\"active_parent no_link\"><a><span class=\"label\">简介</span><span class=\"sub_indicator\"></span></a><ul class=\"show\">\n<li class=\"active_parent no_link\"><a><span class=\"label\">LicheePI Nano</span><span class=\"sub_indicator\"></span></a><ul class=\"show\">\n<li class=\"not_active no_link\"><a><span class=\"label\">上手体验</span><span class=\"sub_indicator sub_indicator_collapsed\"></span></a><ul class=\"\">\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/get_started/first_eye.html\"><span class=\"label\">初见</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/get_started/first_eat.html\"><span class=\"label\">前言</span><span class=\"\"></span></a></li>\n</ul>\n</li>\n<li class=\"active_parent no_link\"><a><span class=\"label\">系统适配篇</span><span class=\"sub_indicator\"></span></a><ul class=\"show\">\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/build_index.html\"><span class=\"label\">总述</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/onekey.html\"><span class=\"label\">镜像包一键烧录</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/docker.html\"><span class=\"label\">docker快速搭建环境</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/bootargs.html\"><span class=\"label\">uboot传递参数</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/kernel.html\"><span class=\"label\">主线linux编译</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/devicetree.html\"><span class=\"label\">设备树添加节点</span><span class=\"\"></span></a></li>\n<li class=\"not_active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/rootfs.html\"><span class=\"label\">根文件系统编译</span><span class=\"\"></span></a></li>\n<li class=\"active with_link\"><a href=\"/hardware/lichee/zh/Nano-Doc-Backup/build_sys/build_flash.html\"><span class=\"label\">SPI-Flash系统编译</span><span class=\"\"></span></a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li class=\"not_active no_link\"><a><span class=\"label\">LicheePI Zero</span><span class=\"sub_indicator sub_indicator_collapsed\"></span></a><ul class=\"\">\n<li class=\"not_active no_link\"><a><span class=\"label\">LicheePI Zero 简介</span><span class=\"\"></span></a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n\n                </div>\n            </div>", "navbar": "\n            <div id=\"navbar\">\n                <div id=\"navbar_menu\">\n                    <a class=\"site_title\" href=\"/\"><img class=\"site_logo\" src=\"/static/image/logo.svg\" alt=\"sipeed wiki logo\"><h2>wiki</h2></a>\n                    <a id=\"navbar_menu_btn\"></a>\n                </div>\n                <div id=\"navbar_items\">\n                    <div>\n                        <ul id=\"nav_left\">\n<li class=\"\"><a  href=\"/\">首页</a></li>\n<li class=\"\"><a target=\"_blank\" href=\"https://www.sipeed.com\">矽速官网</a></li>\n<li class=\"sub_items \"><a>开源软件</a><ul><li class=\"\"><a  href=\"/soft/maixpy/zh/index.html\">Maixpy</a></li>\n<li class=\"\"><a  href=\"/soft/maixpy3/zh/\">Maixpy3</a></li>\n<li class=\"\"><a  href=\"/licheeos/zh/\">Lichee OS</a></li>\n<li class=\"\"><a  href=\"/LonganOS/zh/\">Longan OS</a></li>\n<li class=\"\"><a  href=\"/TangOs/zh/\">Tang OS</a></li>\n</ul>\n</li>\n<li class=\"sub_items active_parent\"><a>开源硬件</a><ul><li class=\"\"><a  href=\"/hardware/maix/zh/\">Maix</a></li>\n<li class=\"\"><a  href=\"/hardware/maixII/zh/\">Maix II</a></li>\n<li class=\"\"><a  href=\"/hardware/maixIII/zh/\">Maix III</a></li>\n<li class=\"\"><a  href=\"/hardware/maixIV/zh/\">Maix IV</a></li>\n<li class=\"active\"><a  href=\"/hardware/lichee/zh/\">Lichee Pi</a></li>\n<li class=\"\"><a  href=\"/hardware/tang/zh/\">Tang</a></li>\n<li class=\"\"><a  href=\"/hardware/longan/zh/\">Longan</a></li>\n</ul>\n</li>\n<li class=\"sub_items \"><a>商业产品</a><ul><li class=\"\"><a  href=\"/hardware/maixface/zh/\">Maix Face</a></li>\n</ul>\n</li>\n<li class=\"sub_items \"><a>云平台</a><ul><li class=\"\"><a target=\"_blank\" href=\"https://www.maixhub.com\">Maixhub 模型训练平台</a></li>\n<li class=\"\"><a target=\"_blank\" href=\"https://www.maixhub.com/onlinecompiler\">固件在线编译</a></li>\n</ul>\n</li>\n<li class=\"\"><a  href=\"/community.html\">社区</a></li>\n<li class=\"\"><a  href=\"https://shop365481095.taobao.com/?spm=a230r.7195193.1997079397.2.8384341c2zZ5uZ\">商城</a></li>\n</ul>\n\n                    </div>\n                    <div>\n                        <ul id=\"nav_right\">\n<li class=\"sub_items \"><a  href=\"\">Language: </a><ul><li class=\"\"><a  href=\"/\">中文</a></li>\n<li class=\"\"><a  href=\"/en/\">English</a></li>\n</ul></li>\n</ul>\n\n                        <ul class=\"nav_plugins\"><li><a id=\"themes\" class=\"light\"></a></li></ul><ul class=\"nav_plugins\"><li><a id=\"search\"><span class=\"icon\"></span><span class=\"placeholder\">搜索</span>\n                            <div id=\"search_hints\">\n                                <span id=\"search_input_hint\">输入关键词，多关键词空格隔开</span>\n                                <span id=\"search_loading_hint\">正在加载，请稍候。。。</span>\n                                <span id=\"search_download_err_hint\">下载文件失败，请刷新重试或检查网络</span>\n                                <span id=\"search_other_docs_result_hint\">来自其它文档的结果</span>\n                                <span id=\"search_curr_doc_result_hint\">当前文档搜索结果</span>\n                            </div></a></li></ul>\n                    </div>\n                </div>\n            </div>", "footer": "\n            <div id=\"footer\">\n                <div id=\"footer_top\">\n                    <ul>\n<li><a>链接</a><ul><li><a target=\"_blank\" href=\"https://www.sipeed.com\">Sipeed</a></li>\n<li><a target=\"_blank\" href=\"https://bbs.sipeed.com/\">BBS 论坛</a></li>\n<li><a target=\"_blank\" href=\"https://maixhub.sipeed.com/\">Maixhub</a></li>\n<li><a target=\"_blank\" href=\"https://sipeed.taobao.com/\">Sipeed 淘宝</a></li>\n<li><a target=\"_blank\" href=\"https://github.com/neutree/teedoc\">使用 teedoc 构建</a></li>\n</ul>\n</li>\n<li><a>网站统计</a><ul><li><a target=\"_blank\" href=\"https://tongji.baidu.com/web/welcome/ico?s=9cb07365544a53067c56c346c838181a\">百度统计</a></li>\n<li><a  href=\"/sitemap.xml\">网站地图</a></li>\n</ul>\n</li>\n<li><a>源码</a><ul><li><a target=\"_blank\" href=\"https://github.com/sipeed/sipeed_wiki\">文档源文件</a></li>\n<li><a target=\"_blank\" href=\"https://github.com/sipeed\">开源项目源码</a></li>\n</ul>\n</li>\n<li><a>关注我们</a><ul><li><a target=\"_blank\" href=\"https://github.com/sipeed\">github</a></li>\n<li><a target=\"_blank\" href=\"https://twitter.com/SipeedIO\">twitter</a></li>\n<li><a target=\"_blank\" href=\"https://sipeed.taobao.com/\">淘宝</a></li>\n<li><a  href=\"/social_group.html\">更多</a></li>\n</ul>\n</li>\n<li><a>联系我们</a><ul><li><a>电话: +86 0755-27808509</a>\n</li>\n<li><a>商业支持: support@sipeed.com</a>\n</li>\n<li><a>地址: 深圳市宝安区新湖路华美居B区1号楼713-715</a>\n</li>\n<li><a  href=\"/join_us.html\">加入我们</a></li>\n</ul>\n</li>\n</ul>\n\n                </div>\n                <div id=\"footer_bottom\">\n                    <ul>\n<li><a target=\"_blank\" href=\"https://www.sipeed.com\">©2018-2021 深圳矽速科技有限公司</a></li>\n<li><a target=\"_blank\" href=\"https://beian.miit.gov.cn/#/Integrated/index\">粤ICP备19015433号-1</a></li>\n</ul>\n\n                </div>\n            </div>", "file_path": "D:/maixpy/Sipeed文档/sipeed_wiki/docs/hardware/lichee/zh/Nano-Doc-Backup/build_sys/build_flash.md"}, "body": ""}